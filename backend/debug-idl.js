const fs = require('fs');

// Load the IDL
const idlPath = './smart-contract/target/idl/guess5_escrow_corrected.json';
const IDL = JSON.parse(fs.readFileSync(idlPath, 'utf8'));

console.log('üîç Debugging IDL structure...');
console.log('üìã IDL sections:', Object.keys(IDL));

// Check if types section exists
if (IDL.types) {
  console.log('‚úÖ Types section found with', IDL.types.length, 'types');
  
  // Find MatchResult type
  const matchResultType = IDL.types.find(type => type.name === 'MatchResult');
  if (matchResultType) {
    console.log('‚úÖ MatchResult type found:', JSON.stringify(matchResultType, null, 2));
  } else {
    console.log('‚ùå MatchResult type not found');
    console.log('üìã Available types:', IDL.types.map(t => t.name));
  }
} else {
  console.log('‚ùå No types section found');
}

// Check instructions section
if (IDL.instructions) {
  console.log('‚úÖ Instructions section found with', IDL.instructions.length, 'instructions');
  
  // Find settle_match instruction
  const settleMatchInstruction = IDL.instructions.find(ix => ix.name === 'settle_match');
  if (settleMatchInstruction) {
    console.log('‚úÖ settle_match instruction found');
    console.log('üìã settle_match args:', JSON.stringify(settleMatchInstruction.args, null, 2));
  } else {
    console.log('‚ùå settle_match instruction not found');
    console.log('üìã Available instructions:', IDL.instructions.map(ix => ix.name));
  }
} else {
  console.log('‚ùå No instructions section found');
}

// Check if there are any circular references or issues
console.log('üîç Checking for potential issues...');

// Look for any references to MatchResult in the entire IDL
const idlString = JSON.stringify(IDL);
const matchResultReferences = (idlString.match(/MatchResult/g) || []).length;
console.log('üìä Total MatchResult references:', matchResultReferences);

// Check if MatchResult is defined before it's used
const typesIndex = idlString.indexOf('"types"');
const instructionsIndex = idlString.indexOf('"instructions"');
const matchResultDefIndex = idlString.indexOf('"name":"MatchResult"');
const matchResultUseIndex = idlString.indexOf('"name":"MatchResult"', matchResultDefIndex + 1);

console.log('üìä Section order analysis:');
console.log('  - types section at index:', typesIndex);
console.log('  - instructions section at index:', instructionsIndex);
console.log('  - MatchResult definition at index:', matchResultDefIndex);
console.log('  - MatchResult usage at index:', matchResultUseIndex);

if (typesIndex < instructionsIndex) {
  console.log('‚úÖ Types section comes before instructions section');
} else {
  console.log('‚ùå Instructions section comes before types section');
}

if (matchResultDefIndex < matchResultUseIndex) {
  console.log('‚úÖ MatchResult is defined before it\'s used');
} else {
  console.log('‚ùå MatchResult is used before it\'s defined');
}



