const { Connection, PublicKey, Keypair, LAMPORTS_PER_SOL } = require('@solana/web3.js');
const { ManualSolanaClient } = require('./src/services/manualSolanaClient.js');

async function testSimpleTransaction() {
  console.log('üß™ Testing Simple Transaction...');
  
  // Connect to devnet
  const connection = new Connection('https://api.devnet.solana.com', 'confirmed');
  const client = new ManualSolanaClient(connection);
  
  try {
    // Test connection
    console.log('üîç Testing connection...');
    const isConnected = await client.testConnection();
    console.log('‚úÖ Connection test:', isConnected ? 'SUCCESS' : 'FAILED');
    
    if (!isConnected) {
      throw new Error('Failed to connect to smart contract');
    }
    
    // Generate test keypairs
    const payer = Keypair.generate();
    
    console.log('üë§ Generated test keypair:');
    console.log('  Payer:', payer.publicKey.toString());
    
    // Request airdrop for payer
    console.log('üí∞ Requesting airdrop for payer...');
    try {
      const airdropSignature = await connection.requestAirdrop(payer.publicKey, 1 * LAMPORTS_PER_SOL);
      await connection.confirmTransaction(airdropSignature);
      console.log('‚úÖ Airdrop successful');
    } catch (airdropError) {
      console.log('‚ö†Ô∏è  Airdrop failed, but continuing with test...');
    }
    
    // Check payer balance
    const payerBalance = await connection.getBalance(payer.publicKey);
    console.log('üí∞ Payer balance:', payerBalance / LAMPORTS_PER_SOL, 'SOL');
    
    if (payerBalance < 0.1 * LAMPORTS_PER_SOL) {
      console.log('‚ö†Ô∏è  Insufficient balance for testing. Please fund the payer manually.');
      console.log('   Payer address:', payer.publicKey.toString());
      return;
    }
    
    console.log('\nüéØ Testing initialize instruction...');
    
    // Create a simple initialize instruction
    const instruction = new TransactionInstruction({
      keys: [
        { pubkey: payer.publicKey, isSigner: true, isWritable: true },
      ],
      programId: new PublicKey("rnJUt7xoxQvZpPqvY5LeQ3qUYSBnYfLKa5B8K5SWh6X"),
      data: Buffer.from([175, 175, 109, 31, 13, 152, 155, 237]), // initialize discriminator
    });
    
    // Create and send transaction
    const transaction = new Transaction().add(instruction);
    const signature = await sendAndConfirmTransaction(
      connection,
      transaction,
      [payer],
      { commitment: 'confirmed' }
    );
    
    console.log('‚úÖ Initialize transaction successful!');
    console.log('  Signature:', signature);
    
    console.log('\nüéâ Simple transaction test completed!');
    
  } catch (error) {
    console.error('‚ùå Test failed:', error.message);
  }
}

// Import sendAndConfirmTransaction
const { sendAndConfirmTransaction } = require('@solana/web3.js');

// Run the test
testSimpleTransaction().catch(console.error);
