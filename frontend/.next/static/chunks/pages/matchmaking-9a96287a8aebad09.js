(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[938],{2479:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/matchmaking",function(){return a(9488)}])},3874:function(e,t){"use strict";t.Z={src:"/_next/static/media/logo.174882b4.png",height:1024,width:1024,blurDataURL:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAIAAABLbSncAAAAwElEQVR42mMQllESlVMRk1MRl1cVAyI5FVFZJWEZZQYRWWUOMTkeCXkGASkGfilGUTlOGWURGSUGXkkFdV19RXVtIzNzYwtLfX19dQVFPqAOIJg4sWvFivlr1y5ZunLR6lk9rY4MDOKaQHHu6Jionp62jo7mtvamrvaGUDc7BnYJBj5JBQkFVStbOwsbWysbW2sHR0ktA34JeZDlgtJKDDwgJUALGTjFBCXkgYIMQjJKQEpcQVVcHoSADCBXWEYJABn5I+WumxzZAAAAAElFTkSuQmCC",blurWidth:8,blurHeight:8}},9702:function(e,t,a){"use strict";a.d(t,{K:function(){return usePendingClaims}});var n=a(7294),l=a(4306),r=a(1163),s=a(4155);let usePendingClaims=()=>{let{publicKey:e}=(0,l.O)(),t=(0,r.useRouter)(),[a,o]=(0,n.useState)(null),[d,i]=(0,n.useState)(!1),[c,u]=(0,n.useState)(null),checkPendingClaims=async()=>{if(!e){o(null);return}i(!0),u(null);try{let t=await fetch("".concat(s.env.NEXT_PUBLIC_API_URL,"/api/match/check-pending-claims/").concat(e.toString()));if(!t.ok)throw Error("Failed to check pending claims");let a=await t.json();o(a)}catch(e){u(e instanceof Error?e.message:"Unknown error"),console.error("Error checking pending claims:",e)}finally{i(!1)}},redirectToClaim=e=>{t.push("/result?matchId=".concat(e))},redirectToRefund=e=>{t.push("/result?matchId=".concat(e))};return(0,n.useEffect)(()=>{e?checkPendingClaims():o(null)},[e]),(0,n.useEffect)(()=>{if(!a||!e)return;let n=t.pathname;if("/result"!==n&&"/"!==n){if(a.hasPendingWinnings&&a.pendingWinnings.length>0){let e=a.pendingWinnings[0];console.log("\uD83C\uDFAF Player has pending winnings, redirecting to claim:",e.matchId),redirectToClaim(e.matchId);return}if(a.hasPendingRefunds&&a.refundCanBeExecuted&&a.pendingRefunds.length>0){let e=a.pendingRefunds[0];console.log("\uD83C\uDFAF Player has executable refund, redirecting to claim:",e.matchId),redirectToRefund(e.matchId);return}a.hasPendingRefunds&&!a.refundCanBeExecuted&&console.log("⏳ Player has pending refunds but cannot execute yet")}},[a,e,t.pathname]),{pendingClaims:a,loading:d,error:c,checkPendingClaims,redirectToClaim,redirectToRefund,hasBlockingClaims:(null==a?void 0:a.hasPendingWinnings)||(null==a?void 0:a.hasPendingRefunds)&&(null==a?void 0:a.refundCanBeExecuted)}}},9488:function(e,t,a){"use strict";a.r(t);var n=a(5893),l=a(7294),r=a(1163),s=a(4306),o=a(3182),d=a(5675),i=a.n(d),c=a(3874),u=a(960),m=a(1910),h=a(9702),g=a(4155);t.default=()=>{var e,t,a,d,p,f;let y=(0,r.useRouter)(),{publicKey:v,signTransaction:x,sendTransaction:b}=(0,s.O)(),{hasBlockingClaims:w,pendingClaims:P}=(0,h.K)(),I="string"==typeof y.query.entryFee?y.query.entryFee:void 0,[_,A]=(0,l.useState)("waiting"),[S,N]=(0,l.useState)(0),[j,q]=(0,l.useState)(null),[F,k]=(0,l.useState)(0),[V,C]=(0,l.useState)(!1),[T,E]=(0,l.useState)(!1),[R,D]=(0,l.useState)(!1),[L,O]=(0,l.useState)(!1),[U,W]=(0,l.useState)(null),[M,B]=(0,l.useState)(null),[G,Q]=(0,l.useState)("0s"),[X,J]=(0,l.useState)(null),[Y,K]=(0,l.useState)(!1),Z=(null==v?void 0:v.toString())||null,$=(0,l.useMemo)(()=>{if(!j)return null;let e=!!Z&&j.player1&&Z===j.player1,t=e?!!j.player1Paid:!!j.player2Paid,a=e?!!j.player2Paid:!!j.player1Paid,n=j.refundReason;if("opponent_left"===_)return{heading:"Opponent Left",detail:"Your opponent exited before paying. Re-queueing you for another match.",tone:"info",encourageResult:!1};if("refund_pending"===_){let e;let a="warning",l=!0;switch(n){case"payment_timeout":e=t?"The opponent never finished paying. A refund proposal is being assembled—open the result screen shortly to co-sign your SOL back. Your refund will be available within 2-3 minutes after the proposal is created.":"The opponent never finished paying. We cancelled the match automatically before SOL moved.",t||(a="info",l=!1);break;case"player_cancelled_after_payment":e="The other player backed out after you deposited. The multisig refund will appear in the result view within ~2 minutes. Once the proposal is created, you can sign to receive your full refund.";break;case"player_cancelled_before_payment":e="The match ended before any deposits were collected. No funds left your wallet.",a="info",l=!1;break;default:e=t?"We are preparing your refund proposal now. Visit the result screen to co-sign once it appears.":"Match cancelled before any deposits were at risk.",a=t?"warning":"info",l=t}return{heading:"Refund Pending",detail:e,tone:a,encourageResult:l}}return"queue_cancelled"===_?{heading:"Queue Cancelled",detail:"You left the matchmaking queue. Join again any time.",tone:"info",encourageResult:!1}:"cancelled"===_?"player_cancelled_before_payment"!==n&&(t||a)?"payment_timeout"===n||"player_cancelled_after_payment"===n?{heading:"Match Cancelled - Refund Inbound",detail:"Funds from your deposit are safe. The refund proposal will appear soon in your result feed.",tone:"warning",encourageResult:!0}:{heading:"Match Cancelled",detail:t?"Your deposit is being returned. Check the result page shortly to sign the refund proposal.":"Opponent left the queue. No deposits were taken.",tone:t?"warning":"info",encourageResult:t}:{heading:"Match Cancelled",detail:"The opponent bailed before anyone deposited. No funds moved.",tone:"info",encourageResult:!1}:null},[_,j,Z]),z=(0,l.useRef)(null),H=(0,l.useRef)("waiting");(0,l.useEffect)(()=>{if(w&&v){if(console.log("\uD83D\uDEAB Player has pending claims, redirecting from matchmaking"),(null==P?void 0:P.hasPendingWinnings)&&P.pendingWinnings.length>0){let e=P.pendingWinnings[0];y.push("/result?matchId=".concat(e.matchId));return}if((null==P?void 0:P.hasPendingRefunds)&&P.refundCanBeExecuted&&P.pendingRefunds.length>0){let e=P.pendingRefunds[0];y.push("/result?matchId=".concat(e.matchId));return}}},[w,P,v,y]),(0,l.useEffect)(()=>{let fetchSolPrice=async()=>{try{let e=g.env.NEXT_PUBLIC_API_URL||"https://guess5.onrender.com",t=await fetch("".concat(e,"/api/match/sol-price"));if(t.ok){let e=await t.json();e.price&&"number"==typeof e.price&&e.price>0?J(e.price):e.fallback&&J(e.fallback)}}catch(e){console.error("❌ Error fetching SOL price:",e),J(180)}};fetchSolPrice();let e=setInterval(fetchSolPrice,3e4);return()=>clearInterval(e)},[]),(0,l.useEffect)(()=>{if("waiting"===_&&M){let e=setInterval(()=>{let e=Math.floor((Date.now()-M)/1e3),t=Math.floor(e/60),a=e%60;Q(t>0?"".concat(t,"m ").concat(a,"s"):"".concat(a,"s"))},1e3);return()=>clearInterval(e)}"waiting"!==_&&(B(null),Q("0s"))},[_,M]);let handleCancelAndReturn=async()=>{if(!Y){if(!v){y.push("/lobby");return}K(!0);try{var e,t;let a=(null===(e=z.current)||void 0===e?void 0:e.matchId)||(null===(t=z.current)||void 0===t?void 0:t.id)||(null==j?void 0:j.matchId)||void 0,n=await (0,m.e7)(v.toString(),a);if(z.current=null,q(null),C(!1),E(!1),N(0),B(null),(null==n?void 0:n.status)==="queue_cancelled"?A("queue_cancelled"):(null==n?void 0:n.status)==="cancelled"&&A((null==n?void 0:n.refundPending)?"refund_pending":"cancelled"),(null==n?void 0:n.refundPending)&&a){localStorage.setItem("matchId",a),(null==j?void 0:j.entryFee)&&localStorage.setItem("entryFee",j.entryFee.toString()),y.push("/result?matchId=".concat(a));return}y.push("/lobby")}catch(e){console.error("❌ Error cancelling matchmaking:",e),y.push("/lobby")}finally{K(!1)}}},handlePayment=async()=>{let e=j||z.current;if(console.log("\uD83D\uDDB1️ Deposit button clicked",{isPaymentInProgress:L,hasMatchData:!!j,hasMatchDataRef:!!z.current,hasPublicKey:!!v,matchId:null==e?void 0:e.matchId,status:_}),L){console.log("⚠️ Payment already in progress - ignoring click");let e=window.__lastPaymentAttempt||0,t=Date.now();if(!(t-e>12e4))return;console.warn("⚠️ isPaymentInProgress has been stuck for >2 minutes - resetting"),O(!1),await new Promise(e=>setTimeout(e,500))}if(window.__lastPaymentAttempt=Date.now(),!v){console.error("❌ No publicKey available"),alert("Wallet not connected. Please connect your wallet and try again.");return}if(!e||!e.matchId){console.error("❌ No match data available",{hasMatchData:!!j,hasMatchDataRef:!!z.current,matchId:null==e?void 0:e.matchId}),alert("Match data not available. Please refresh the page and try again.");return}console.log("✅ Starting payment process..."),O(!0);let t=setTimeout(()=>{console.warn("⚠️ Payment safety timeout - resetting payment state"),O(!1)},12e4);try{let e,l;let r=j||z.current;if(!r||!r.matchId){console.error("❌ Match data lost during payment",{hadMatchData:!!j,hadMatchDataRef:!!z.current}),clearTimeout(t),O(!1),alert("Match data lost. Please refresh the page and try again.");return}!j&&z.current&&q(z.current),console.log("✅ Validation passed, proceeding with payment...",{matchId:r.matchId,playerWallet:v.toString(),entryFee:F,hasVaultAddress:!!(r.squadsVaultAddress||r.vaultAddress),hasDepositAddress:!!(r.squadsVaultPda||r.vaultPda)});let s="function"==typeof b,d="function"==typeof x;if(!s&&!d){console.error("❌ Wallet adapter missing both sendTransaction and signTransaction capabilities"),alert("Your connected wallet cannot send transactions in this context. Please reconnect your wallet or try a different one."),clearTimeout(t),O(!1);return}let i=v.toString()===r.player1,c=i?r.player1Paid:r.player2Paid;if(c){console.log("⚠️ Current player already paid"),clearTimeout(t),O(!1);return}if(console.log("\uD83D\uDCB0 Starting payment to multisig vault deposit..."),r.status&&"payment_required"!==r.status&&"vault_pending"!==r.status){clearTimeout(t),O(!1),"cancelled"===r.status?A("opponent_left"):"refund_pending"===r.status&&A("refund_pending");return}try{if(e=await (0,m.L$)(r.matchId),console.log("✅ Fetched latest match status",{hasVaultAddress:!!((null==e?void 0:e.squadsVaultAddress)||(null==e?void 0:e.vaultAddress)),hasDepositAddress:!!((null==e?void 0:e.squadsVaultPda)||(null==e?void 0:e.vaultPda)),status:null==e?void 0:e.status}),e){let t={...r,...e,squadsVaultAddress:e.squadsVaultAddress||r.squadsVaultAddress||r.vaultAddress,vaultAddress:e.vaultAddress||e.squadsVaultAddress||r.vaultAddress||r.squadsVaultAddress,squadsVaultPda:e.squadsVaultPda||r.squadsVaultPda||r.vaultPda,vaultPda:e.vaultPda||e.squadsVaultPda||r.vaultPda||r.squadsVaultPda};q(t),z.current=t}}catch(e){console.warn("⚠️ Unable to fetch latest match status before payment",e)}let u=["payment_required","waiting_for_payment"];if((null==e?void 0:e.status)&&!u.includes(e.status)){if("cancelled"===e.status){let t=!!e.player1Paid||!!e.player2Paid;t?(A("refund_pending"),q(t=>t?{...t,...e,status:"refund_pending"}:e),z.current={...z.current||{},...e,status:"refund_pending"}):(A("opponent_left"),q(t=>t?{...t,...e,status:"opponent_left"}:e),z.current={...z.current||{},...e,status:"opponent_left"})}else"refund_pending"===e.status||"refunded"===e.status?(A("refund_pending"),q(t=>t?{...t,...e,status:"refund_pending"}:e),z.current={...z.current||{},...e,status:"refund_pending"}):A(e.status);clearTimeout(t),O(!1);return}(null==e?void 0:e.status)&&u.includes(e.status)&&(q(t=>t?{...t,...e}:e),z.current={...z.current||{},...e});let h=g.env.NEXT_PUBLIC_SOLANA_NETWORK||"https://api.devnet.solana.com",p=new o.Connection(h,"confirmed"),f=await p.getBalance(v),w=Math.floor(F*o.LAMPORTS_PER_SOL);if(f<w)throw Error("Insufficient balance. You have ".concat((f/o.LAMPORTS_PER_SOL).toFixed(4)," SOL, but need ").concat(F," SOL"));let resolveVaultAddresses=async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,a=e||r||z.current,n=(null==a?void 0:a.squadsVaultAddress)||(null==a?void 0:a.vaultAddress)||null,l=(null==a?void 0:a.squadsVaultPda)||(null==a?void 0:a.vaultPda)||null;if(console.log("\uD83D\uDD0D Resolving vault addresses",{matchId:r.matchId,hasMultisigAddress:!!n,hasDepositAddress:!!l,attempt:1}),l&&n)return console.log("✅ Vault addresses found in match data"),{multisigAddress:n,depositAddress:l};for(let e=1;e<=t;e++)try{console.log("\uD83D\uDD04 Fetching vault addresses from backend (attempt ".concat(e,"/").concat(t,")..."));let a=await (0,m.L$)(r.matchId);if(n=(null==a?void 0:a.squadsVaultAddress)||(null==a?void 0:a.vaultAddress)||n,l=(null==a?void 0:a.squadsVaultPda)||(null==a?void 0:a.vaultPda)||l,console.log("✅ Fetched vault addresses from backend",{hasMultisigAddress:!!n,hasDepositAddress:!!l,attempt:e}),n||l){var s,o,d,i;let e={...r||z.current||{},...a,squadsVaultAddress:null!==(s=null!=n?n:null==r?void 0:r.squadsVaultAddress)&&void 0!==s?s:null==r?void 0:r.vaultAddress,vaultAddress:null!==(o=null!=n?n:null==r?void 0:r.vaultAddress)&&void 0!==o?o:null==r?void 0:r.squadsVaultAddress,squadsVaultPda:null!==(d=null!=l?l:null==r?void 0:r.squadsVaultPda)&&void 0!==d?d:null==r?void 0:r.vaultPda,vaultPda:null!==(i=null!=l?l:null==r?void 0:r.vaultPda)&&void 0!==i?i:null==r?void 0:r.squadsVaultPda};if(q(e),z.current=e,l&&n)return{multisigAddress:n,depositAddress:l}}!l&&e<t&&(console.log("⏳ Waiting before retry (attempt ".concat(e,"/").concat(t,")...")),await new Promise(t=>setTimeout(t,1e3*e)))}catch(a){console.warn("⚠️ Failed to fetch vault addresses (attempt ".concat(e,"/").concat(t,"):"),a),e<t&&await new Promise(t=>setTimeout(t,1e3*e))}return{multisigAddress:n,depositAddress:l}},{multisigAddress:P,depositAddress:I}=await resolveVaultAddresses();if(!I)throw Error("Vault deposit address not found. Please wait a moment and try again, or refresh the page.");console.log("✅ Using vault addresses for payment",{depositAddress:I.slice(0,8)+"..."+I.slice(-8),hasMultisigAddress:!!P});let _=new o.Transaction().add(o.SystemProgram.transfer({fromPubkey:v,toPubkey:new o.PublicKey(I),lamports:w})),{blockhash:S,lastValidBlockHeight:N}=await p.getLatestBlockhash("finalized");if(_.recentBlockhash=S,_.feePayer=v,s)console.log("\uD83D\uDCE4 Sending transaction via wallet adapter..."),l=await b(_,p,{skipPreflight:!1,maxRetries:3}),console.log("✅ Transaction sent with signature:",l),await p.confirmTransaction({blockhash:S,lastValidBlockHeight:N,signature:l},"confirmed"),console.log("✅ Transaction confirmed successfully");else{if(!d)throw Error("Wallet does not support signing transactions");console.log("\uD83D\uDD10 Signing transaction...");let e=await x(_);console.log("\uD83D\uDCE4 Sending transaction to Solana...");try{l=await p.sendRawTransaction(e.serialize(),{skipPreflight:!1,maxRetries:3}),console.log("✅ Transaction sent with signature:",l)}catch(e){var a,n;if((null==e?void 0:null===(a=e.message)||void 0===a?void 0:a.includes("already been processed"))||(null==e?void 0:null===(n=e.message)||void 0===n?void 0:n.includes("This transaction has already been processed")))throw console.log("⚠️ Transaction already processed - extracting signature from error"),Error("Transaction was already submitted. Please check your wallet for the transaction signature.");throw e}console.log("⏳ Waiting for transaction confirmation..."),await p.confirmTransaction({blockhash:S,lastValidBlockHeight:N,signature:l},"confirmed"),console.log("✅ Transaction confirmed successfully")}let k=await fetch("".concat(g.env.NEXT_PUBLIC_API_URL,"/api/multisig/deposits"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({matchId:r.matchId,playerWallet:v.toString(),amount:F,depositTxSignature:l})});if(!k.ok){let e=await k.text();throw console.error("❌ Failed to notify backend of deposit",{status:k.status,statusText:k.statusText,error:e}),Error("Failed to notify backend of deposit: ".concat(k.status," ").concat(k.statusText))}let V=await k.json();console.log("✅ Deposit confirmed by backend:",V);let C=await fetch("".concat(g.env.NEXT_PUBLIC_API_URL,"/api/match/status/").concat(r.matchId));if(!C.ok)throw Error("Failed to fetch match status: ".concat(C.status," ").concat(C.statusText));let T=await C.json();if(q(e=>{var t,a;return{...e,...T,player1Paid:!!i||(null!==(t=T.player1Paid)&&void 0!==t?t:e.player1Paid),player2Paid:!i||(null!==(a=T.player2Paid)&&void 0!==a?a:e.player2Paid)}}),"active"===T.status){console.log("✅ Match is active, redirecting to game..."),A("active"),localStorage.setItem("matchId",r.matchId),T.word&&localStorage.setItem("word",T.word),T.entryFee&&localStorage.setItem("entryFee",T.entryFee.toString()),clearTimeout(t),O(!1),setTimeout(()=>{y.push("/game?matchId=".concat(r.matchId))},500);return}let E=T.player1Paid&&T.player2Paid||"payment_required"===T.status&&T.depositAConfirmations>=1&&T.depositBConfirmations>=1,R=i?T.player1Paid:T.player2Paid;if(E)console.log("✅ Both players paid, waiting for game to start..."),A("waiting_for_game");else if(R)console.log("⏳ Current player paid, waiting for opponent to pay..."),A("waiting_for_payment");else{console.log("⏳ Current player has not paid yet..."),A("payment_required");let e=setTimeout(()=>{console.log("⏰ Payment timeout - redirecting to lobby"),alert("Game failed to start within 2 minutes. Please try again."),y.push("/lobby")},12e4);W(e)}}catch(e){console.error("❌ Payment error:",e),alert("Payment failed: ".concat(e instanceof Error?e.message:"Unknown error"))}finally{clearTimeout(t),O(!1)}};return(0,l.useEffect)(()=>()=>{U&&clearTimeout(U)},[U]),(0,l.useEffect)(()=>{let e;if(!v){y.push("/");return}if(T||j&&j.matchId)return;E(!0);let startPolling=()=>{e&&clearInterval(e),e=setInterval(async()=>{let t=z.current;try{if("waiting"!==H.current&&t&&t.matchId){if(t&&t.matchId)try{let a=await (0,m.L$)(t.matchId);q(e=>{var t,n,l,r,s,o,d,i,c,u,m,h;let g=(null==a?void 0:a.squadsVaultAddress)||(null==a?void 0:a.vaultAddress)||(null==e?void 0:e.vaultAddress)||null,p=(null==a?void 0:a.squadsVaultPda)||(null==a?void 0:a.vaultPda)||(null==e?void 0:e.squadsVaultPda)||(null==e?void 0:e.vaultPda)||null,f={...e,player1Paid:a.player1Paid,player2Paid:a.player2Paid,status:a.status,refundReason:null!==(n=null!==(t=null==a?void 0:a.refundReason)&&void 0!==t?t:null==e?void 0:e.refundReason)&&void 0!==n?n:null,matchOutcome:null!==(r=null!==(l=null==a?void 0:a.matchOutcome)&&void 0!==l?l:null==e?void 0:e.matchOutcome)&&void 0!==r?r:null,entryFee:null!==(o=null!==(s=a.entryFee)&&void 0!==s?s:null==e?void 0:e.entryFee)&&void 0!==o?o:null,depositAConfirmations:"number"==typeof(null==a?void 0:a.depositAConfirmations)?null==a?void 0:a.depositAConfirmations:null!==(d=null==e?void 0:e.depositAConfirmations)&&void 0!==d?d:0,depositBConfirmations:"number"==typeof(null==a?void 0:a.depositBConfirmations)?null==a?void 0:a.depositBConfirmations:null!==(i=null==e?void 0:e.depositBConfirmations)&&void 0!==i?i:0,squadsVaultAddress:null!==(u=null!==(c=null==a?void 0:a.squadsVaultAddress)&&void 0!==c?c:null==e?void 0:e.squadsVaultAddress)&&void 0!==u?u:g,vaultAddress:g,squadsVaultPda:null!==(h=null!==(m=null==a?void 0:a.squadsVaultPda)&&void 0!==m?m:null==e?void 0:e.squadsVaultPda)&&void 0!==h?h:p,vaultPda:p};return z.current=f,f});let n=a.status;if("active"===n){A("active"),localStorage.setItem("matchId",t.matchId),a.word&&localStorage.setItem("word",a.word),a.entryFee&&localStorage.setItem("entryFee",a.entryFee.toString()),clearInterval(e),C(!1),setTimeout(()=>{y.push("/game?matchId=".concat(t.matchId))},500);return}if("cancelled"===n){let n=!!a.player1Paid||!!a.player2Paid;z.current={...z.current||{},status:n?"refund_pending":"opponent_left"},q(e=>e?{...e,status:n?"refund_pending":"opponent_left"}:e),clearInterval(e),C(!1),E(!1),n?(A("refund_pending"),t.matchId&&(localStorage.setItem("matchId",t.matchId),a.entryFee&&localStorage.setItem("entryFee",a.entryFee.toString()))):(localStorage.removeItem("matchId"),localStorage.removeItem("word"),localStorage.removeItem("entryFee"),A("opponent_left"));return}if("refund_pending"===n||"refunded"===n){z.current={...z.current||{},status:"refund_pending"},q(e=>e?{...e,status:"refund_pending"}:e),A("refund_pending"),clearInterval(e),C(!1),E(!1),t.matchId&&(localStorage.setItem("matchId",t.matchId),a.entryFee&&localStorage.setItem("entryFee",a.entryFee.toString()));return}let l=(null==v?void 0:v.toString())===a.player1?a.player1Paid:(null==v?void 0:v.toString())===a.player2&&a.player2Paid,r=a.player1Paid&&a.player2Paid||a.depositAConfirmations>=1&&a.depositBConfirmations>=1;if(r&&"active"===n){A("active"),localStorage.setItem("matchId",t.matchId),a.word&&localStorage.setItem("word",a.word),a.entryFee&&localStorage.setItem("entryFee",a.entryFee.toString()),clearInterval(e),C(!1),setTimeout(()=>{y.push("/game?matchId=".concat(t.matchId))},500);return}if("waiting_for_payment"===n&&l)r?(console.log("✅ Both players paid, waiting for status to update..."),A("waiting_for_game"),setTimeout(()=>{("waiting_for_game"===H.current||"waiting_for_payment"===H.current)&&(console.log("⏰ Status not updated, redirecting to game anyway..."),localStorage.setItem("matchId",t.matchId),a.word&&localStorage.setItem("word",a.word),a.entryFee&&localStorage.setItem("entryFee",a.entryFee.toString()),y.push("/game?matchId=".concat(t.matchId)))},2e3)):A("waiting_for_payment");else if("payment_required"!==n||l){if("completed"===n){A("completed"),clearInterval(e),C(!1),E(!1);return}}else A("payment_required");r&&"active"!==a.status&&"refund_pending"!==n&&"cancelled"!==n&&"waiting_for_payment"!==n&&A("waiting_for_game")}catch(e){console.error("❌ Error polling for match status:",e)}}else try{let t=await (0,m.$u)(v.toString());if(t.matched){clearInterval(e),E(!1);let a={...t,matchId:t.matchId,player1:t.player1,player2:t.player2,player1Username:t.player1Username||null,player2Username:t.player2Username||null,entryFee:t.entryFee||F,status:"payment_required",player1Paid:t.player1Paid||!1,player2Paid:t.player2Paid||!1,squadsVaultAddress:t.squadsVaultAddress||t.vaultAddress||null,vaultAddress:t.vaultAddress||t.squadsVaultAddress||null,squadsVaultPda:t.squadsVaultPda||t.vaultPda||null,vaultPda:t.vaultPda||t.squadsVaultPda||null};q(a),z.current=a,O(!1),A("payment_required"),C(!0),startPolling();return}}catch(e){console.error("❌ Error checking for match:",e),console.error("❌ Error details:",e instanceof Error?e.message:String(e)),e instanceof Error&&("AbortError"===e.name||e.message.includes("timeout")?console.log("⏰ Network timeout - will retry on next poll cycle"):e.message.includes("Failed to fetch")&&console.log("\uD83C\uDF10 Network error - will retry on next poll cycle"))}}catch(e){console.error("❌ Error polling for match:",e),console.error("❌ Error details:",e instanceof Error?e.message:String(e))}},2e3)},startMatchmaking=async()=>{if(!v||R)return;let t=F,a=y.query.entryFee;if(a)t=parseFloat(a);else{let e=localStorage.getItem("entryFeeSOL");e&&(t=parseFloat(e))}if(!t||t<=0){console.error("❌ No valid entry fee found"),A("error");return}D(!0);try{let a=localStorage.getItem("referralCode"),n=await (0,m.B2)(v.toString(),t,a||void 0);if(a&&n.matchId)try{let e=g.env.NEXT_PUBLIC_API_URL||"https://guess5-backend.onrender.com";await fetch("".concat(e,"/api/referral/link"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({referredWallet:v.toString(),referrerWallet:a})}),localStorage.removeItem("referralCode")}catch(e){console.warn("Failed to process referral:",e)}if("waiting"===n.status)N(n.waitingCount||0),A("waiting"),M||B(Date.now()),V||(C(!0),startPolling());else if("matched"===n.status){let a={...n,matchId:n.matchId,player1:n.player1,player2:n.player2,player1Username:n.player1Username||null,player2Username:n.player2Username||null,entryFee:n.entryFee||t,status:"payment_required",player1Paid:n.player1Paid||!1,player2Paid:n.player2Paid||!1,squadsVaultAddress:n.squadsVaultAddress||n.vaultAddress||null,vaultAddress:n.vaultAddress||n.squadsVaultAddress||null,squadsVaultPda:n.squadsVaultPda||n.vaultPda||null,vaultPda:n.vaultPda||n.squadsVaultPda||null};q(a),z.current=a,O(!1),A("payment_required"),clearInterval(e),C(!1),E(!1)}else if("vault_pending"===n.status){let e={matchId:n.matchId,player1:n.player1,player2:n.player2,entryFee:t,status:"payment_required",player1Paid:!1,player2Paid:!1,squadsVaultAddress:null,vaultAddress:null,squadsVaultPda:null,vaultPda:null};q(e),z.current=e,O(!1),V||(C(!0),startPolling())}else n.error&&A("error")}catch(e){console.error("❌ Matchmaking error:",e),console.error("❌ Error details:",e instanceof Error?e.message:String(e)),A("error")}finally{D(!1)}},t=y.query.matchId;if(t){let e=y.query.entryFee,a=e?parseFloat(e):0,n={matchId:t,player1:y.query.player1,player2:y.query.player2,entryFee:a,status:"payment_required",player1Paid:!1,player2Paid:!1,squadsVaultAddress:null,vaultAddress:null,squadsVaultPda:null,vaultPda:null};q(n),z.current=n,O(!1),A("payment_required"),k(a),localStorage.setItem("entryFeeSOL",a.toString()),V||(C(!0),startPolling());return}let a=y.query.entryFee;if(a){let e=parseFloat(a);k(e),localStorage.setItem("entryFeeSOL",e.toString())}else{let e=localStorage.getItem("entryFeeSOL");e&&k(parseFloat(e))}return z.current&&z.current.matchId||startMatchmaking(),V||(C(!0),startPolling()),()=>{clearInterval(e),E(!1)}},[v,y,x,F]),(0,l.useEffect)(()=>{H.current=_},[_]),(0,l.useEffect)(()=>{(null==j?void 0:j.matchId)&&("refund_pending"===_?(localStorage.setItem("matchId",j.matchId),j.entryFee&&localStorage.setItem("entryFee",j.entryFee.toString())):("cancelled"===_||"queue_cancelled"===_||"opponent_left"===_)&&(localStorage.removeItem("matchId"),localStorage.removeItem("word"),localStorage.removeItem("entryFee")))},[_,null==j?void 0:j.matchId,null==j?void 0:j.entryFee]),(0,l.useEffect)(()=>{"completed"===_&&(null==j?void 0:j.matchId)&&y.push("/result?matchId=".concat(j.matchId))},[_,null==j?void 0:j.matchId,y]),(0,l.useEffect)(()=>{if("opponent_left"!==_)return;let e=I?parseFloat(I):NaN,t=(null==j?void 0:j.entryFee)||F||(Number.isNaN(e)?void 0:e),a=t&&!Number.isNaN(t)?"/matchmaking?entryFee=".concat(t):"/matchmaking",n="".concat(a).concat(a.includes("?")?"&":"?","requeue=").concat(Date.now()),l=setTimeout(()=>{y.replace(n)},2200);return()=>clearTimeout(l)},[_,null==j?void 0:j.entryFee,F,y,I]),(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center min-h-screen bg-primary px-2 relative",children:[(0,n.jsx)(u.F,{}),(0,n.jsxs)("div",{className:"flex flex-col items-center",children:[(0,n.jsx)("div",{className:"logo-shell mb-6 sm:mb-8",children:(0,n.jsx)(i(),{src:c.Z,alt:"Guess5 Logo",width:200,height:200,priority:!0})}),(0,n.jsxs)("div",{className:"bg-secondary bg-opacity-10 rounded-lg p-6 max-w-md w-full text-center shadow",children:["waiting"===_&&(0,n.jsxs)("div",{className:"animate-fade-in",children:[(0,n.jsxs)("div",{className:"flex items-center justify-center mb-6",children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-accent mr-3"}),(0,n.jsx)("h2",{className:"text-2xl font-bold text-accent",children:"Finding Opponent..."})]}),(0,n.jsx)("div",{className:"text-white/80 mb-6 text-center",children:"Waiting for another player to join"}),(null==j?void 0:j.player2Username)&&(0,n.jsx)("div",{className:"bg-accent/20 border border-accent/30 rounded-lg p-4 mb-6 text-center",children:(0,n.jsxs)("div",{className:"text-accent text-lg font-bold",children:["Match found against @",j.player2Username,"!"]})}),(0,n.jsxs)("div",{className:"space-y-3 mb-6",children:[(0,n.jsxs)("div",{className:"bg-secondary bg-opacity-20 rounded-lg p-4 border border-accent/20",children:[(0,n.jsx)("div",{className:"text-white/60 text-xs uppercase tracking-wide mb-1",children:"Entry Fee"}),(0,n.jsx)("div",{className:"text-accent text-lg font-semibold",children:X&&F?"$".concat((F*X).toFixed(2)," USD"):"—"}),(0,n.jsxs)("div",{className:"text-white/70 text-sm mt-1",children:[F," SOL"]})]}),(0,n.jsxs)("div",{className:"bg-secondary bg-opacity-20 rounded-lg p-4 border border-accent/20",children:[(0,n.jsx)("div",{className:"text-white/60 text-xs uppercase tracking-wide mb-1",children:"Time in Queue"}),(0,n.jsx)("div",{className:"text-accent text-xl font-bold font-mono",children:G})]})]}),(0,n.jsx)("button",{onClick:handleCancelAndReturn,disabled:Y,className:"w-full py-2.5 px-4 rounded-lg transition-all duration-200 border ".concat(Y?"bg-white/5 border-white/10 text-white/40 cursor-not-allowed":"bg-white/10 hover:bg-white/20 text-white border-white/20"),children:Y?"Cancelling...":"← Cancel & Return to Lobby"})]}),"payment_required"===_&&((null==j?void 0:j.matchId)||(null===(e=z.current)||void 0===e?void 0:e.matchId))&&(0,n.jsxs)("div",{className:"animate-fade-in",children:[(0,n.jsx)("h2",{className:"text-2xl font-bold text-accent mb-2",children:"Payment Required"}),(0,n.jsx)("p",{className:"text-white/70 text-sm mb-6",children:"Send your entry fee to the secure multisig vault"}),(0,n.jsxs)("div",{className:"bg-secondary bg-opacity-20 rounded-lg p-4 mb-4 border border-accent/20",children:[(0,n.jsx)("div",{className:"text-white/60 text-xs uppercase tracking-wide mb-2",children:"Entry Fee"}),(0,n.jsx)("div",{className:"text-accent text-xl font-bold",children:X&&F?"$".concat((F*X).toFixed(2)," USD"):"—"}),(0,n.jsxs)("div",{className:"text-white/70 text-sm mt-1",children:[F," SOL"]})]}),!(j.squadsVaultPda||j.vaultPda||j.squadsVaultAddress||j.vaultAddress)&&(0,n.jsxs)("div",{className:"bg-yellow-500/20 border border-yellow-500/40 rounded-lg p-3 mb-4",children:[(0,n.jsxs)("div",{className:"flex items-center justify-center mb-2",children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-yellow-400 mr-2"}),(0,n.jsx)("div",{className:"text-yellow-400 text-sm font-medium",children:"Preparing secure vault..."})]}),(0,n.jsx)("p",{className:"text-white/70 text-xs text-center",children:"This usually takes a few seconds"})]}),(j.squadsVaultPda||j.vaultPda||j.squadsVaultAddress||j.vaultAddress)&&(0,n.jsxs)("div",{className:"bg-green-500/10 border border-green-500/30 rounded-lg p-3 mb-4",children:[(0,n.jsx)("div",{className:"text-green-400 text-sm font-medium mb-1",children:"✓ Vault Ready"}),(0,n.jsxs)("div",{className:"text-white/60 text-xs break-all font-mono",children:[null===(t=j.squadsVaultPda||j.vaultPda||j.squadsVaultAddress||j.vaultAddress)||void 0===t?void 0:t.slice(0,8),"...",null===(a=j.squadsVaultPda||j.vaultPda||j.squadsVaultAddress||j.vaultAddress)||void 0===a?void 0:a.slice(-8)]})]}),(0,n.jsx)("button",{onClick:handlePayment,disabled:L||!((null==j?void 0:j.matchId)||(null===(d=z.current)||void 0===d?void 0:d.matchId))||!v,className:"w-full font-bold py-3.5 px-6 rounded-lg transition-all duration-200 min-h-[52px] flex items-center justify-center ".concat(!L&&((null==j?void 0:j.matchId)||(null===(p=z.current)||void 0===p?void 0:p.matchId))&&v?"bg-accent hover:bg-yellow-400 hover:shadow-lg text-primary transform hover:scale-[1.02] active:scale-[0.98]":"bg-gray-600 cursor-not-allowed text-gray-400"),children:L?(0,n.jsxs)("span",{className:"flex items-center justify-center",children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-primary mr-2"}),"Processing Payment..."]}):((null==j?void 0:j.matchId)||(null===(f=z.current)||void 0===f?void 0:f.matchId))&&v?"Pay ".concat(F," SOL Entry Fee"):"Waiting for Match..."}),(0,n.jsx)("div",{className:"mt-4 text-center",children:(0,n.jsx)("button",{onClick:handleCancelAndReturn,disabled:Y,className:"text-white/60 hover:text-white text-sm underline transition-colors disabled:text-white/30 disabled:hover:text-white/30",children:Y?"Cancelling...":"Cancel"})})]}),"waiting_for_payment"===_&&j&&(0,n.jsxs)("div",{className:"animate-fade-in",children:[(0,n.jsxs)("div",{className:"flex items-center justify-center mb-4",children:[(0,n.jsx)("div",{className:"animate-pulse w-3 h-3 bg-accent rounded-full mr-3"}),(0,n.jsx)("h2",{className:"text-2xl font-bold text-accent",children:"Waiting for Opponent"})]}),(()=>{let e=Z===j.player1,t=e?j.player2Username:j.player1Username;return t&&(0,n.jsxs)("p",{className:"text-white/70 text-sm mb-4 text-center",children:["Waiting for @",t," to pay their entry fee"]})})(),(0,n.jsxs)("div",{className:"bg-green-500/10 border border-green-500/30 rounded-lg p-4 mb-4",children:[(0,n.jsx)("div",{className:"text-green-400 text-sm font-medium mb-1",children:"✓ Your payment confirmed"}),(0,n.jsx)("p",{className:"text-white/70 text-sm",children:"Waiting for your opponent to pay their entry fee"})]})]}),"waiting_for_game"===_&&(0,n.jsxs)("div",{className:"animate-fade-in",children:[(0,n.jsxs)("div",{className:"flex items-center justify-center mb-4",children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-accent mr-3"}),(0,n.jsx)("h2",{className:"text-2xl font-bold text-accent",children:"Preparing Game"})]}),(0,n.jsx)("div",{className:"bg-green-500/10 border border-green-500/30 rounded-lg p-4 mb-4",children:(null==j?void 0:j.player1Paid)&&(null==j?void 0:j.player2Paid)?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"text-green-400 text-sm font-medium mb-1",children:"✓ Both players paid"}),(0,n.jsx)("p",{className:"text-white/70 text-sm",children:"Game starting soon..."})]}):(0,n.jsx)("p",{className:"text-white/70 text-sm",children:"Waiting for other player to pay..."})})]}),"active"===_&&(0,n.jsxs)("div",{className:"animate-fade-in",children:[(0,n.jsxs)("div",{className:"flex items-center justify-center mb-4",children:[(0,n.jsx)("div",{className:"animate-pulse w-3 h-3 bg-green-400 rounded-full mr-3"}),(0,n.jsx)("h2",{className:"text-2xl font-bold text-green-400",children:"Game Starting"})]}),(0,n.jsx)("p",{className:"text-white/70 text-center",children:"Redirecting to game..."})]}),"error"===_&&(0,n.jsxs)("div",{className:"animate-fade-in",children:[(0,n.jsx)("div",{className:"text-red-400 text-4xl mb-4 text-center",children:"⚠️"}),(0,n.jsx)("h2",{className:"text-2xl font-bold text-red-400 mb-2 text-center",children:"Something Went Wrong"}),(0,n.jsx)("p",{className:"text-white/70 text-sm mb-6 text-center",children:"An error occurred during matchmaking. Please try again."}),(0,n.jsx)("button",{onClick:()=>y.push("/lobby"),className:"w-full bg-accent hover:bg-yellow-400 text-primary font-bold py-3 px-6 rounded-lg transition-all duration-200 hover:shadow-lg transform hover:scale-[1.02] active:scale-[0.98]",children:"Return to Lobby"})]}),("cancelled"===_||"refund_pending"===_||"queue_cancelled"===_||"opponent_left"===_)&&(0,n.jsxs)("div",{className:"animate-fade-in",children:[(()=>{var e;let t=null!==(e=null==$?void 0:$.tone)&&void 0!==e?e:"info",a={info:{icon:"ℹ️",heading:"text-white",border:"border-white/15",background:"bg-white/5"},warning:{icon:"⏰",heading:"text-yellow-400",border:"border-yellow-500/40",background:"bg-yellow-500/10"},success:{icon:"✅",heading:"text-green-400",border:"border-green-500/30",background:"bg-green-500/10"}}[t];return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"".concat(a.heading," text-4xl mb-4 text-center"),children:a.icon}),(0,n.jsx)("h2",{className:"text-2xl font-bold mb-2 text-center ".concat(a.heading),children:(null==$?void 0:$.heading)||("refund_pending"===_?"Refund Pending":"queue_cancelled"===_?"Queue Cancelled":"Match Cancelled")}),(0,n.jsx)("div",{className:"".concat(a.background," border ").concat(a.border," rounded-lg p-4 mb-6"),children:(0,n.jsx)("p",{className:"text-white/80 text-sm text-center",children:(null==$?void 0:$.detail)||"Match cancelled. Queue up again whenever you are ready."})})]})})(),(0,n.jsxs)("div",{className:"flex flex-col gap-3",children:[(null==$?void 0:$.encourageResult)&&(null==j?void 0:j.matchId)&&(0,n.jsx)("button",{onClick:()=>{var e;let t=(null===(e=z.current)||void 0===e?void 0:e.matchId)||(null==j?void 0:j.matchId)||y.query.matchId;t&&y.push("/result?matchId=".concat(t))},className:"w-full bg-white/10 hover:bg-white/20 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 border border-white/20",children:"View Refund Status"}),(0,n.jsx)("button",{onClick:()=>y.push("/lobby"),className:"w-full bg-accent hover:bg-yellow-400 text-primary font-bold py-3 px-6 rounded-lg transition-all duration-200 hover:shadow-lg transform hover:scale-[1.02] active:scale-[0.98]",children:"Return to Lobby"})]})]})]})]})]})}},1163:function(e,t,a){e.exports=a(9974)}},function(e){e.O(0,[675,960,774,888,179],function(){return e(e.s=2479)}),_N_E=e.O()}]);